name: Test Orchestrator


on:
  repository_dispatch:
    types: [trigger-tests]
env:
  DEFAULT_ENVIRONMENT: test
  DEFAULT_TEST_QUERY: pytest -m api 
  

jobs:
  test_run:
    runs-on: ubuntu-latest
    steps:
      - name: Set defaults for client payload
        run: |
          echo "ENVIRONMENT=${{ github.event.client_payload.ENVIRONMENT || env.DEFAULT_ENVIRONMENT }}" >> $GITHUB_ENV
          echo "TEST_QUERY=${{ github.event.client_payload.TEST_QUERY || env.DEFAULT_TEST_QUERY }}" >> $GITHUB_ENV
          echo "SLACK=${{ github.event.client_payload.SLACK || false }}" >> $GITHUB_ENV
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Test Runs
        run: |
          echo "Environment: ${{ env.ENVIRONMENT }}" 
          echo "Test Query: ${{ env.TEST_QUERY }}"
          echo "SLACK: ${{ env.SLACK }}"

      - name: Pytest
        run: |
          pip install pytest
      - name: Run test
        run: |
          ls
          cd src
          pytest ${{ env.TEST_QUERY }}
      
      - name: Extract Payload Data
        run: |
          echo "Triggered by: ${{ github.event.client_payload.triggered_by }}"

      - name: Slack Notification
        if: env.SLACK == 'true'
        run: |
            echo "Slack is enabled"


